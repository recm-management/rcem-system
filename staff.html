<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RCEM ‚Äì Staff</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f4f6f9}
.header{
  background:linear-gradient(135deg,#0d47a1,#1976d2);
  color:#fff;padding:16px;display:flex;justify-content:space-between;align-items:center
}
.back{cursor:pointer}
.search{padding:14px}
.search input{
  width:100%;padding:13px 18px;border-radius:30px;border:1px solid #ccc;font-size:15px
}
.top-actions{padding:0 16px}
.add-btn{
  padding:10px 18px;border:none;border-radius:22px;
  background:linear-gradient(45deg,#2e7d32,#43a047);
  color:#fff;font-size:14px;cursor:pointer
}
.container{padding:16px}
.card{
  background:#fff;border-radius:18px;padding:16px;margin-bottom:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
  display:flex;gap:14px
}
.avatar{
  width:56px;height:56px;border-radius:50%;
  background:#e3f2fd;overflow:hidden;
  display:flex;align-items:center;justify-content:center
}
.avatar img{width:100%;height:100%;object-fit:cover}
.info{flex:1}
.name{font-size:16px;font-weight:bold}
.serial{color:#1976d2;font-weight:bold;margin-right:6px}
.meta{font-size:14px;color:#555;margin-top:4px}
.meta a{color:#1565c0;text-decoration:none}
.badge{
  display:inline-block;padding:4px 10px;border-radius:12px;
  font-size:12px;margin-top:6px;color:#fff
}
.leader{background:#6a1b9a}
.second{background:#1565c0}
.member{background:#2e7d32}
.new{background:#757575}
.level{
  margin-top:6px;background:#e3f2fd;padding:5px 12px;
  border-radius:12px;font-size:13px;display:inline-block
}
.actions{display:flex;flex-direction:column;gap:8px}
.btn{padding:8px 12px;border:none;border-radius:14px;font-size:13px;cursor:pointer}
.edit{background:#1565c0;color:#fff}
.rate{background:#f9a825}

.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center
}
.modal-box{
  background:#fff;padding:18px;border-radius:18px;
  width:100%;max-width:420px
}
.modal-box input,.modal-box select{
  width:100%;padding:12px;margin-bottom:12px;
  border-radius:12px;border:1px solid #ccc
}
.preview{
  width:90px;height:90px;border-radius:50%;
  margin:10px auto;background:#eee;
  overflow:hidden;display:flex;align-items:center;justify-content:center
}
.preview img{width:100%;height:100%;object-fit:cover}
.modal-box button{
  width:100%;padding:12px;border:none;border-radius:22px;
  background:#2e7d32;color:#fff;font-size:15px
}
.cancel{text-align:center;margin-top:10px;color:#555;cursor:pointer}
</style>
</head>

<body>

<div class="header">
  <div class="back" onclick="history.back()">‚Üê Back</div>
  <h3>Staff List</h3>
</div>

<div class="search">
  <input id="search" placeholder="üîç Search by name or phone" oninput="render()">
</div>

<div class="top-actions">
  <button id="addBtn" class="add-btn" onclick="openModal()">+ Add Staff</button>
</div>

<div class="container" id="list">Loading...</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Add Staff</h3>

    <div class="preview">
      <img id="photoPreview" src="">
    </div>

    <input type="file" id="photoInput" accept="image/*" capture="environment">

    <input id="staffName" placeholder="Name">
    <input id="staffPhone" placeholder="Phone">
    <input id="staffAddress" placeholder="Address">

    <select id="staffBadge">
      <option value="new">New Member</option>
      <option value="member">Member</option>
      <option value="second_leader">Second Leader</option>
      <option value="leader">Leader</option>
    </select>

    <button onclick="save()">Save</button>
    <div class="cancel" onclick="closeModal()">Cancel</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDK3dqXZuWaH3gctxURdOZc_Q1UfioesaA",
  authDomain:"rcem-system.firebaseapp.com",
  projectId:"rcem-system"
});

const db = firebase.firestore();
let staffs=[],editId=null,selectedImage=null;

db.collection("staffs").onSnapshot(s=>{
  staffs=[];s.forEach(d=>staffs.push({id:d.id,...d.data()}));
  render();
});

photoInput.onchange=e=>{
  selectedImage=e.target.files[0];
  const r=new FileReader();
  r.onload=()=>photoPreview.src=r.result;
  r.readAsDataURL(selectedImage);
};

function render(){
  list.innerHTML="";
  let i=1,k=search.value.toLowerCase();
  staffs.forEach(s=>{
    if(!s.name?.toLowerCase().includes(k) && !s.phone?.includes(k))return;
    const img=s.photo||"";
    list.innerHTML+=`
    <div class="card">
      <div class="avatar">
        ${img?`<img src="${img}">`:"üë§"}
      </div>
      <div class="info">
        <div class="name"><span class="serial">${i++}.</span>${s.name}</div>
        <div class="meta">üìû <a href="tel:${s.phone}">${s.phone}</a></div>
        <div class="meta">üìç ${s.address||"-"}</div>
        <span class="badge ${s.badge}">${s.badge}</span>
        <div class="level">Level: ${s.level||0} / 100</div>
      </div>
      <div class="actions">
        <button class="btn rate">Give Rating</button>
        <button class="btn edit" onclick='openModal(${JSON.stringify(s).replace(/"/g,"&quot;")})'>Edit</button>
      </div>
    </div>`;
  });
}

function openModal(s=null){
  modal.style.display="flex";
  selectedImage=null;
  if(s){
    editId=s.id;
    staffName.value=s.name;
    staffPhone.value=s.phone;
    staffAddress.value=s.address;
    staffBadge.value=s.badge;
    photoPreview.src=s.photo||"";
  }else{
    editId=null;
    staffName.value=staffPhone.value=staffAddress.value="";
    staffBadge.value="new";
    photoPreview.src="";
  }
}

function closeModal(){modal.style.display="none"}

async function save(){
  let photoURL=null;
  if(selectedImage){
    photoURL=await resizeAndUpload(selectedImage,editId||Date.now());
  }
  const data={
    name:staffName.value,
    phone:staffPhone.value,
    address:staffAddress.value,
    badge:staffBadge.value
  };
  if(photoURL)data.photo=photoURL;
  editId
    ?await db.collection("staffs").doc(editId).update(data)
    :await db.collection("staffs").add({...data,level:0,active:true});
  closeModal();
}

function resizeAndUpload(file,id){
  return new Promise(res=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement("canvas");
      c.width=c.height=300;
      c.getContext("2d").drawImage(img,0,0,300,300);
      c.toBlob(b=>{
        const url=`uploads/staffs/staff_${id}.jpg`;
        fetch(url,{method:"PUT",body:b}).then(()=>res(url));
      },"image/jpeg",0.7);
    };
    img.src=URL.createObjectURL(file);
  });
}
</script>

</body>
</html>
