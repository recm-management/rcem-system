<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Staff List</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
.header{background:#1565c0;color:#fff;padding:14px;display:flex;justify-content:space-between}
.search{padding:12px}
.search input{width:100%;padding:12px;border-radius:25px;border:1px solid #ccc}
.add-btn{margin:0 12px 12px;background:#2e7d32;color:#fff;border:none;padding:10px 18px;border-radius:20px}
.card{background:#fff;margin:12px;border-radius:16px;padding:14px;display:flex;gap:12px;box-shadow:0 8px 18px rgba(0,0,0,.12)}
.avatar{width:55px;height:55px;border-radius:50%;background:#e3f2fd;display:flex;align-items:center;justify-content:center;font-size:26px}
.badge{padding:4px 10px;border-radius:12px;font-size:12px;color:#fff}
.leader{background:#6a1b9a}
.member{background:#2e7d32}
.second{background:#1565c0}
.actions button{border:none;padding:8px 12px;border-radius:14px;margin-top:6px}
.rate{background:#f9a825}
.edit{background:#1565c0;color:#fff}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.box{background:#fff;padding:18px;border-radius:16px;width:90%;max-width:420px}
.box input,.box select{width:100%;padding:12px;margin-bottom:10px;border-radius:12px;border:1px solid #ccc}
</style>
</head>

<body>

<div class="header">
  <span onclick="history.back()">‚Üê Back</span>
  <b>Staff List</b>
</div>

<div class="search">
  <input id="search" placeholder="Search by name or phone" oninput="render()">
</div>

<button id="addBtn" class="add-btn" onclick="openModal()">+ Add Staff</button>

<div id="list"></div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="box">
    <h3 id="title">Add Staff</h3>

    <input id="name" placeholder="Name">
    <input id="phone" placeholder="Phone">
    <input id="address" placeholder="Address">

    <select id="badge">
      <option value="new">New Member</option>
      <option value="member">Member</option>
      <option value="second_leader">Second Leader</option>
      <option value="leader">Leader</option>
    </select>

    <!-- üî• CRITICAL FIX -->
    <button type="button" onclick="save()" style="background:#2e7d32;color:#fff;border:none;padding:12px;border-radius:22px">
      Save
    </button>

    <div onclick="closeModal()" style="text-align:center;margin-top:8px;color:#555">Cancel</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDK3dqXZuWaH3gctxURdOZc_Q1UfioesaA",
  authDomain:"rcem-system.firebaseapp.com",
  projectId:"rcem-system"
});

const auth=firebase.auth();
const db=firebase.firestore();

let staffs=[], perms={}, editId=null, ready=false;

auth.onAuthStateChanged(async u=>{
  if(!u){location.href="index.html";return}
  const d=(await db.collection("users").doc(u.email).get()).data()||{};
  perms=d.permissions||{};
  if(d.role==="super_admin") perms.staff_add=perms.staff_edit=true;
  if(!perms.staff_add) addBtn.style.display="none";
  ready=true; render();
});

db.collection("staffs").onSnapshot(s=>{
  staffs=[]; s.forEach(d=>staffs.push({id:d.id,...d.data()}));
  render();
});

function render(){
  if(!ready) return;
  list.innerHTML="";
  let i=1, k=search.value.toLowerCase();
  staffs.forEach(s=>{
    if(!s.name?.toLowerCase().includes(k)&&!s.phone?.includes(k))return;
    list.innerHTML+=`
    <div class="card">
      <div class="avatar">üë§</div>
      <div style="flex:1">
        <b>${i++}. ${s.name}</b><br>
        üìû <a href="tel:${s.phone}">${s.phone}</a><br>
        üìç ${s.address||"-"}<br>
        <span class="badge leader">${s.badge||"Member"}</span>
      </div>
      <div class="actions">
        <button class="rate">Rating</button>
        ${perms.staff_edit?`<button class="edit" onclick='openModal(${JSON.stringify(s).replace(/"/g,"&quot;")})'>Edit</button>`:""}
      </div>
    </div>`;
  });
}

function openModal(s=null){
  modal.style.display="flex";
  if(s){
    editId=s.id;
    title.innerText="Edit Staff";
    name.value=s.name; phone.value=s.phone;
    address.value=s.address||""; badge.value=s.badge||"new";
  }else{
    editId=null;
    title.innerText="Add Staff";
    name.value=phone.value=address.value="";
    badge.value="new";
  }
}
function closeModal(){modal.style.display="none"}

function save(){
  const n=name.value.trim(), p=phone.value.trim();
  if(!n||!p){alert("Name ‡¶è‡¶¨‡¶Ç Phone ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞");return}

  const data={name:n,phone:p,address:address.value.trim(),badge:badge.value};

  if(editId){
    if(!perms.staff_edit) return alert("No permission");
    db.collection("staffs").doc(editId).update(data).then(closeModal);
  }else{
    if(!perms.staff_add) return alert("No permission");
    db.collection("staffs").add({...data,level:0,rating:0,created:Date.now()})
      .then(closeModal);
  }
}
</script>

</body>
</html>
