<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assignments</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f4f6f9}

.header{
  background:#0d47a1;
  color:#fff;
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center
}
.back{cursor:pointer}

.add-btn{
  margin:16px;
  padding:12px 24px;
  border:none;
  border-radius:25px;
  background:linear-gradient(45deg,#2e7d32,#43a047);
  color:#fff;
  font-size:15px;
  cursor:pointer
}

.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  margin:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.12)
}
.title{
  font-size:18px;
  font-weight:bold;
  margin-bottom:10px
}
.program{
  background:#f6f8fb;
  border-radius:14px;
  padding:12px;
  margin-bottom:10px
}
.meta{
  font-size:14px;
  margin:4px 0
}

.badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:18px;
  font-size:12px;
  background:#f9a825;
  color:#fff;
  margin-top:8px
}

.actions{
  display:flex;
  gap:10px;
  margin-top:10px
}
.edit-btn{
  flex:1;
  background:#1976d2;
  color:#fff;
  border:none;
  padding:8px;
  border-radius:18px;
  cursor:pointer
}
.del-btn{
  flex:1;
  background:#d32f2f;
  color:#fff;
  border:none;
  padding:8px;
  border-radius:18px;
  cursor:pointer
}
</style>
</head>

<body>

<div class="header">
  <div class="back" onclick="history.back()">‚Üê Back</div>
  <h3>Assignments</h3>
</div>

<button class="add-btn" id="addBtn"
 onclick="location.href='create-assignment.html'">
 + Create Assignment
</button>

<div id="list"></div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDK3dqXZuWaH3gctxURdOZc_Q1UfioesaA",
  authDomain:"rcem-system.firebaseapp.com",
  projectId:"rcem-system"
});

const auth=firebase.auth();
const db=firebase.firestore();

let canEdit=false, canDelete=false;

/* AUTH */
auth.onAuthStateChanged(async user=>{
  if(!user){ location.href="index.html"; return; }

  const u=await db.collection("users").doc(user.email).get();
  const p=u.data()?.permissions || {};

  canEdit = p.assignments_edit === true;
  canDelete = p.assignments_delete === true;

  if(!p.assignments_add)
    document.getElementById("addBtn").style.display="none";
});

/* LOAD */
db.collection("assignments")
.orderBy("created","desc")
.onSnapshot(snap=>{
  const grouped={};

  snap.forEach(d=>{
    const a=d.data();
    const venue=a.venue_name || "‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø";
    if(!grouped[venue]) grouped[venue]=[];
    grouped[venue].push({id:d.id,...a});
  });

  const list=document.getElementById("list");
  list.innerHTML="";

  Object.keys(grouped).forEach(v=>{
    list.innerHTML+=`
      <div class="card">
        <div class="title">${v}</div>

        ${grouped[v].map(p=>`
          <div class="program">
            <div class="meta">üìÖ ${p.duty_date || "-"}</div>
            <div class="meta">üë• ‡¶∏‡ßç‡¶ü‡¶æ‡¶´: ${(p.staff_names?.length)||0}</div>

            <span class="badge">ACTIVE</span>

            ${(canEdit || canDelete)?`
            <div class="actions">
              ${canEdit?`
                <button class="edit-btn"
                  onclick="editAssign('${p.id}')">‚úèÔ∏è Edit</button>`:""}
              ${canDelete?`
                <button class="del-btn"
                  onclick="deleteAssign('${p.id}')">üóë Delete</button>`:""}
            </div>`:""}
          </div>
        `).join("")}

      </div>
    `;
  });
});

/* EDIT */
function editAssign(id){
  location.href=`create-assignment.html?edit=${id}`;
}

/* DELETE */
function deleteAssign(id){
  if(!confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
  db.collection("assignments").doc(id).delete();
}
</script>

</body>
</html>
