<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RCEM ‚Äì Assignments</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f4f6f9}

/* HEADER */
.header{
  background:#0d47a1;
  color:#fff;
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center
}
.back{cursor:pointer}

/* TOP */
.top-actions{padding:16px}
.add-btn{
  padding:12px 22px;
  border:none;
  border-radius:25px;
  background:linear-gradient(45deg,#2e7d32,#43a047);
  color:#fff;
  font-size:15px;
  cursor:pointer
}

/* CONTAINER */
.container{padding:16px}

/* VENUE CARD */
.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  margin-bottom:18px;
  box-shadow:0 8px 22px rgba(0,0,0,.12)
}

.title{
  font-size:18px;
  font-weight:bold;
  margin-bottom:10px
}

/* PROGRAM ROW */
.program{
  background:#f5f7fb;
  border-radius:12px;
  padding:12px;
  margin-bottom:10px
}

.meta{
  font-size:14px;
  margin:4px 0;
  color:#333
}

/* BADGE + ACTIONS */
.footer{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:10px
}

.badge{
  padding:6px 14px;
  border-radius:18px;
  font-size:12px;
  color:#fff;
  background:#f9a825
}

.actions button{
  border:none;
  border-radius:12px;
  padding:6px 12px;
  margin-left:6px;
  cursor:pointer;
  font-size:12px
}
.edit{background:#1976d2;color:#fff}
.delete{background:#d32f2f;color:#fff}

/* EMPTY */
.empty{
  background:#fff;
  padding:26px;
  border-radius:18px;
  text-align:center;
  color:#777;
  box-shadow:0 8px 22px rgba(0,0,0,.12)
}
</style>
</head>

<body>

<div class="header">
  <div class="back" onclick="history.back()">‚Üê Back</div>
  <h3>Assignments</h3>
</div>

<div class="top-actions">
  <button class="add-btn" onclick="location.href='create-assignment.html'">
    + Create Assignment
  </button>
</div>

<div class="container" id="list">Loading...</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDK3dqXZuWaH3gctxURdOZc_Q1UfioesaA",
  authDomain:"rcem-system.firebaseapp.com",
  projectId:"rcem-system"
});

const db = firebase.firestore();

/* LOAD ALL DATA */
Promise.all([
  db.collection("venues").get(),
  db.collection("assignments").get(),
  db.collection("assignment_staffs").get()
]).then(([vSnap,aSnap,sSnap])=>{

  const venues = {};
  vSnap.forEach(d=>venues[d.id]=d.data().venue_name);

  const staffCount = {};
  sSnap.forEach(d=>{
    const a=d.data().assignment_id;
    staffCount[a]=(staffCount[a]||0)+1;
  });

  const grouped = {};
  aSnap.forEach(d=>{
    const a=d.data();
    if(!grouped[a.venue_id]) grouped[a.venue_id]=[];
    grouped[a.venue_id].push({
      id:d.id,
      ...a,
      assigned:staffCount[d.id]||0
    });
  });

  render(grouped,venues);
});

/* RENDER */
function render(data,venues){
  const list=document.getElementById("list");
  list.innerHTML="";

  if(!Object.keys(data).length){
    list.innerHTML=`<div class="empty">‡¶ï‡ßã‡¶®‡ßã Assignment ‡¶®‡ßá‡¶á</div>`;
    return;
  }

  Object.keys(data).forEach(venueId=>{
    const programs=data[venueId];
    const venueName=venues[venueId]||"‡¶®‡¶æ‡¶Æ ‡¶®‡ßá‡¶á";

    let html=`<div class="card">
      <div class="title">${venueName}</div>`;

    programs
      .sort((a,b)=>a.date.localeCompare(b.date))
      .forEach(p=>{
        const shift=p.shift==="day"?"üåû ‡¶¶‡¶ø‡¶®":p.shift==="night"?"üåô ‡¶∞‡¶æ‡¶§":"-";
        html+=`
        <div class="program">
          <div class="meta">üìÖ ${p.date}</div>
          <div class="meta">‚è∞ ${shift}</div>
          <div class="meta">üë• ‡¶∏‡ßç‡¶ü‡¶æ‡¶´: ${p.assigned} / ${p.staff_required||0}</div>

          <div class="footer">
            <span class="badge">ACTIVE</span>
            <div class="actions">
              <button class="edit" onclick="editProgram('${p.id}')">Edit</button>
              <button class="delete" onclick="deleteProgram('${p.id}')">Delete</button>
            </div>
          </div>
        </div>`;
      });

    html+=`</div>`;
    list.innerHTML+=html;
  });
}

/* ACTIONS */
function editProgram(id){
  location.href="create-assignment.html?edit="+id;
}

function deleteProgram(id){
  if(!confirm("‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßã‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
  db.collection("assignments").doc(id).delete().then(()=>{
    location.reload();
  });
}
</script>

</body>
</html>
