<script>
const db = firebase.firestore();

db.collection("assignments")
  .orderBy("date")
  .onSnapshot(async snap => {

    const venueMap = {};

    snap.forEach(doc => {
      const a = doc.data();
      a.id = doc.id;

      if (!venueMap[a.venue_id]) {
        venueMap[a.venue_id] = {
          venue_name: a.venue_name,
          programs: []
        };
      }

      venueMap[a.venue_id].programs.push(a);
    });

    renderVenues(venueMap);
  });

async function renderVenues(map) {
  const list = document.getElementById("list");
  list.innerHTML = "";

  for (const vid in map) {
    const venue = map[vid];
    const count = venue.programs.length;

    let programsHTML = "";

    venue.programs.forEach(p => {
      programsHTML += `
        <div class="sub-card">
          <div>ЁЯУЕ ${p.date}</div>
          <div>ЁЯХТ ${p.shift === "day" ? "Day" : "Night"}</div>
          <div>ЁЯСе ржкрзНрж░рзЯрзЛржЬржирзАрзЯ рж╕рзНржЯрж╛ржл: ${p.staff_required || 0}</div>
          <div class="actions">
            <button onclick="editProgram('${p.id}')">тЬПя╕П Edit</button>
            <button onclick="deleteProgram('${p.id}')">ЁЯЧС Delete</button>
          </div>
        </div>
      `;
    });

    list.innerHTML += `
      <div class="card">
        <div class="title">${venue.venue_name}</div>
        <div class="meta">
          Upcoming Programs: <b>${count}</b>
        </div>

        <details>
          <summary>ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржжрзЗржЦрзБржи</summary>
          ${programsHTML}
        </details>

        <span class="badge active">ACTIVE</span>
      </div>
    `;
  }
}

function editProgram(id) {
  location.href = "create-assignment.html?id=" + id;
}

function deleteProgram(id) {
  if (!confirm("ржПржЗ ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржбрж┐рж▓рж┐ржЯ ржХрж░ржмрзЗржи?")) return;

  db.collection("assignments").doc(id).delete();
}
</script>
