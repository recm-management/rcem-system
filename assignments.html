<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assignments</title>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f4f6f9}

/* HEADER */
.header{
  background:#0d47a1;
  color:#fff;
  padding:16px;
  display:flex;
  align-items:center;
  justify-content:space-between
}
.back{cursor:pointer}

/* BUTTON */
.add-btn{
  margin:16px;
  padding:12px 24px;
  border:none;
  border-radius:25px;
  background:linear-gradient(45deg,#2e7d32,#43a047);
  color:#fff;
  font-size:15px;
  cursor:pointer
}

/* CARD */
.card{
  background:#fff;
  border-radius:18px;
  padding:16px;
  margin:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.12)
}
.title{
  font-size:18px;
  font-weight:bold;
  margin-bottom:10px
}
.program{
  background:#f6f8fb;
  border-radius:14px;
  padding:12px;
  margin-bottom:10px
}
.meta{
  font-size:14px;
  margin:4px 0;
  color:#333
}

/* BADGE */
.badge{
  display:inline-block;
  padding:6px 14px;
  border-radius:18px;
  font-size:12px;
  color:#fff;
  background:#f9a825;
  margin-top:10px
}

/* ACTION BUTTONS */
.actions{
  display:flex;
  gap:10px;
  margin-top:10px
}
.edit-btn{
  flex:1;
  padding:8px;
  border:none;
  border-radius:18px;
  background:#1976d2;
  color:#fff;
  cursor:pointer
}
.del-btn{
  flex:1;
  padding:8px;
  border:none;
  border-radius:18px;
  background:#d32f2f;
  color:#fff;
  cursor:pointer
}
</style>
</head>

<body>

<div class="header">
  <div class="back" onclick="history.back()">‚Üê Back</div>
  <h3>Assignments</h3>
</div>

<button class="add-btn" id="addBtn"
 onclick="location.href='create-assignment.html'">
 + Create Assignment
</button>

<div id="list"></div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDK3dqXZuWaH3gctxURdOZc_Q1UfioesaA",
  authDomain:"rcem-system.firebaseapp.com",
  projectId:"rcem-system"
});

const auth=firebase.auth();
const db=firebase.firestore();

let canEdit=false, canDelete=false;

/* AUTH & PERMISSION */
auth.onAuthStateChanged(async user=>{
  if(!user){location.href="index.html";return;}
  const u=await db.collection("users").doc(user.email).get();
  const p=u.data()?.permissions||{};
  canEdit=!!p.assignments_edit;
  canDelete=!!p.assignments_delete;
  if(!p.assignments_add)
    document.getElementById("addBtn").style.display="none";
});

/* SHIFT DETECT */
function shiftIcon(t){
  if(!t) return "‚è∞ -";
  if(t.includes("‡¶∞‡¶æ‡¶§")) return "üåô ‡¶∞‡¶æ‡¶§";
  if(t.includes("‡¶∏‡¶ï‡¶æ‡¶≤")||t.includes("‡¶¶‡¶ø‡¶®")) return "üåû ‡¶¶‡¶ø‡¶®";
  return "‚è∞";
}

/* LOAD ASSIGNMENTS */
db.collection("assignments")
.orderBy("created","desc")
.onSnapshot(async snap=>{
  const byVenue={};

  for(const d of snap.docs){
    const a=d.data();
    const venue=a.venue_name||"‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø";
    if(!byVenue[venue]) byVenue[venue]=[];
    byVenue[venue].push({id:d.id,...a});
  }

  const list=document.getElementById("list");
  list.innerHTML="";

  Object.keys(byVenue).forEach(v=>{
    const arr=byVenue[v];
    list.innerHTML+=`
      <div class="card">
        <div class="title">${v}</div>
        ${arr.map(p=>`
          <div class="program">
            <div class="meta">üìÖ ${p.date||"-"}</div>
            <div class="meta">${shiftIcon(p.time)}</div>
            <div class="meta">
              üë• ‡¶∏‡ßç‡¶ü‡¶æ‡¶´: ${(p.staff_ids?.length)||0}
              / ${p.staff_required||0}
            </div>

            <span class="badge">ACTIVE</span>

            ${(canEdit||canDelete)?`
            <div class="actions">
              ${canEdit?`
              <button class="edit-btn"
                onclick="editAssign('${p.id}')">‚úèÔ∏è Edit</button>`:""}
              ${canDelete?`
              <button class="del-btn"
                onclick="delAssign('${p.id}')">üóë Delete</button>`:""}
            </div>`:""}
          </div>
        `).join("")}
      </div>
    `;
  });
});

/* EDIT */
function editAssign(id){
  location.href=`create-assignment.html?edit=${id}`;
}

/* DELETE */
function delAssign(id){
  if(!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) return;
  db.collection("assignments").doc(id).delete()
   .then(()=>alert("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá"));
}
</script>

</body>
</html>
