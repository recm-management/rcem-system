<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RCEM ‚Äì Venues</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#f4f6f9}

.header{
  background:#0d47a1;color:#fff;padding:15px;
  display:flex;justify-content:space-between;align-items:center
}
.container{padding:15px}

.btn{
  padding:10px 18px;border:none;border-radius:22px;
  color:#fff;cursor:pointer;font-size:14px
}
.add{background:linear-gradient(45deg,#2e7d32,#43a047)}
.toggle{background:linear-gradient(45deg,#f9a825,#fbc02d);color:#000}
.edit{background:linear-gradient(45deg,#1565c0,#1e88e5)}
.logout{background:#d32f2f}

.card{
  background:#fff;padding:16px;border-radius:18px;
  margin-bottom:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.12)
}

.status-row{
  display:flex;align-items:center;gap:8px;
  margin:6px 0;font-weight:bold
}
.dot{width:12px;height:12px;border-radius:50%}
.active{background:#2e7d32;box-shadow:0 0 6px #2e7d32}
.inactive{background:#d32f2f;box-shadow:0 0 6px #d32f2f}

.meta{font-size:14px;color:#555;margin:4px 0}
.highlight{background:yellow}

.search-box{
  width:100%;padding:12px 16px;margin:15px 0;
  border-radius:25px;border:1px solid #ccc;font-size:15px
}
.filter{
  display:flex;align-items:center;gap:8px;
  margin-bottom:15px;font-weight:bold
}

.stats{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:10px;margin:15px 0
}
.stat{
  background:#fff;padding:12px;border-radius:14px;
  text-align:center;
  box-shadow:0 6px 15px rgba(0,0,0,.12)
}
.stat b{font-size:20px}

.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;
  padding:12px
}
.modal-box{
  background:#fff;padding:18px;border-radius:18px;
  width:100%;max-width:420px
}
.modal-box input{
  width:100%;padding:12px;margin-bottom:12px;
  border-radius:12px;border:1px solid #ccc;font-size:15px
}
</style>
</head>

<body>

<div class="header">
  <h2>RCEM ‚Äì Venues</h2>
  <button class="btn logout" onclick="logout()">Logout</button>
</div>

<div class="container">

  <div class="stats">
    <div class="stat">Total<br><b id="total">0</b></div>
    <div class="stat">Active<br><b id="active">0</b></div>
    <div class="stat">Inactive<br><b id="inactive">0</b></div>
  </div>

  <button class="btn add" onclick="openModal()">+ Add Venue</button>

  <input class="search-box" id="search"
    placeholder="üîç Search venue, mobile or address"
    oninput="render()">

  <div class="filter">
    <input type="checkbox" id="onlyActive" onchange="render()">
    Show Active Only
  </div>

  <div id="venueList">Loading...</div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle">Add Venue</h3>
    <input id="vname" placeholder="Venue Name">
    <input id="vlocation" placeholder="Address">
    <input id="vcontact" placeholder="Mobile">
    <button class="btn add" style="width:100%" onclick="save()">Save</button>
    <p style="text-align:center;cursor:pointer;margin-top:10px"
       onclick="closeModal()">Cancel</p>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDK3dqXZuWaH3gctxURdOZc_Q1UfioesaA",
  authDomain:"rcem-system.firebaseapp.com",
  projectId:"rcem-system"
});

const auth=firebase.auth();
const db=firebase.firestore();

let data=[];
let editId=null;
let perms={};

auth.onAuthStateChanged(async user=>{
  if(!user){
    location.href="index.html";
    return;
  }

  const snap = await db.collection("users").doc(user.email).get();

  if(!snap.exists || snap.data().active!==true){
    alert(
      "‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶è‡¶á ‡¶Ö‡¶™‡¶∂‡¶®‡ßá ‡¶¢‡ßã‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á„ÄÇ\n\n" +
      "‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü: admin@rcem-system.com\n" +
      "‡¶´‡ßã‡¶®: +8801926627000\n\n" +
      "Rajshahi Catering & Event Management"
    );
    await auth.signOut();
    location.href="index.html";
    return;
  }

  perms = snap.data().permissions || {};
});

function logout(){
  auth.signOut().then(()=>location.href="index.html");
}

function openModal(v=null){
  modal.style.display="flex";
  if(v){
    editId=v.id;
    modalTitle.innerText="Edit Venue";
    vname.value=v.venue_name||"";
    vlocation.value=v.location||"";
    vcontact.value=v.contact||"";
  }else{
    editId=null;
    modalTitle.innerText="Add Venue";
    vname.value="";vlocation.value="";vcontact.value="";
  }
}

function closeModal(){ modal.style.display="none"; }

function save(){
  if(editId){
    if(!perms.venues_edit){
      alert("Edit permission ‡¶®‡ßá‡¶á");
      return;
    }
    db.collection("venues").doc(editId).update({
      venue_name:vname.value,
      location:vlocation.value,
      contact:vcontact.value
    });
  }else{
    if(!perms.venues_add){
      alert("Add permission ‡¶®‡ßá‡¶á");
      return;
    }
    db.collection("venues").add({
      venue_name:vname.value,
      location:vlocation.value,
      contact:vcontact.value,
      active:true
    });
  }
  closeModal();
}

function toggle(id,val){
  if(!perms.venues_edit){
    alert("Active / Inactive ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶®‡ßá‡¶á");
    return;
  }
  db.collection("venues").doc(id).update({active:!val});
}

function highlight(t,k){
  if(!k) return t;
  return t.replace(new RegExp(k,"gi"),m=>`<span class="highlight">${m}</span>`);
}

function render(){
  const k=search.value.toLowerCase();
  const only=onlyActive.checked;
  venueList.innerHTML="";
  let t=0,a=0,i=0,serial=1;

  data.forEach(v=>{
    t++;v.active?a++:i++;
    if(only && !v.active) return;
    if(
      !v.venue_name.toLowerCase().includes(k) &&
      !(v.contact||"").includes(k) &&
      !(v.location||"").toLowerCase().includes(k)
    ) return;

    const mapLink=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v.location||"")}`;

    venueList.innerHTML+=`
      <div class="card">
        <b>${serial}. ${highlight(v.venue_name,k)}</b>
        <div class="status-row">
          <div class="dot ${v.active?"active":"inactive"}"></div>
          ${v.active?"Active":"Inactive"}
        </div>
        <div class="meta">üìû ${highlight(v.contact||"",k)}</div>
        <div class="meta">
          üìç <a href="${mapLink}" target="_blank"
          style="text-decoration:none;color:#0d47a1">
          ${highlight(v.location||"",k)}</a>
        </div><br>
        <button class="btn edit" onclick='openModal(${JSON.stringify(v)})'>Edit</button>
        <button class="btn toggle" onclick='toggle("${v.id}",${v.active})'>Toggle</button>
      </div>`;
    serial++;
  });

  total.innerText=t;
  active.innerText=a;
  inactive.innerText=i;
}

db.collection("venues").onSnapshot(s=>{
  data=[];
  s.forEach(d=>data.push({id:d.id,...d.data()}));
  render();
});
</script>

</body>
</html>
