<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Assignment</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
.header{
  background:#0d47a1;color:#fff;padding:16px;
  display:flex;align-items:center;gap:12px
}
.container{padding:16px}
.card{
  background:#fff;padding:18px;border-radius:18px;
  box-shadow:0 8px 22px rgba(0,0,0,.12)
}
select,input{
  width:100%;padding:12px;margin-bottom:12px;
  border-radius:12px;border:1px solid #ccc;font-size:15px
}
.staff-box{
  border:1px solid #ddd;border-radius:14px;
  padding:12px;max-height:220px;overflow:auto
}
.staff-item{
  display:flex;align-items:center;gap:10px;
  padding:6px 0;font-size:15px
}
.btn{
  width:100%;padding:14px;border:none;
  border-radius:26px;background:#2e7d32;
  color:#fff;font-size:16px;cursor:pointer;margin-top:12px
}
.hidden{display:none}
</style>
</head>

<body>

<div class="header">
  <span onclick="history.back()" style="cursor:pointer">← Back</span>
  <h3>Create Assignment</h3>
</div>

<div class="container">
  <div class="card">

    <!-- ASSIGNMENT TYPE -->
    <select id="type" onchange="toggleType()">
      <option value="">Assignment টাইপ নির্বাচন করুন</option>
      <option value="venue">Venue Assignment</option>
      <option value="custom">Custom / Order Assignment</option>
    </select>

    <!-- VENUE SELECT -->
    <select id="venueSelect" class="hidden"></select>

    <!-- CUSTOM PLACE -->
    <input id="customPlace" class="hidden"
      placeholder="অনুষ্ঠান / জায়গার নাম লিখুন">

    <!-- DUTY DATE -->
    <input type="date" id="dutyDate">

    <!-- STAFF -->
    <div class="staff-box" id="staffBox">Loading staff...</div>

    <button class="btn" onclick="save()">Create Assignment</button>

  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDK3dqXZuWaH3gctxURdOZc_Q1UfioesaA",
  authDomain:"rcem-system.firebaseapp.com",
  projectId:"rcem-system"
});

const auth=firebase.auth();
const db=firebase.firestore();

let staffs=[], venues=[];

/* LOAD DATA */
db.collection("staffs").onSnapshot(s=>{
  staffs=[];
  s.forEach(d=>staffs.push({id:d.id,...d.data()}));
  renderStaff();
});

db.collection("venues").where("active","==",true).onSnapshot(s=>{
  venues=[];
  s.forEach(d=>venues.push({id:d.id,...d.data()}));
  renderVenues();
});

/* UI LOGIC */
function toggleType(){
  const t=type.value;
  venueSelect.classList.toggle("hidden",t!=="venue");
  customPlace.classList.toggle("hidden",t!=="custom");
}

function renderVenues(){
  venueSelect.innerHTML="<option value=''>Venue নির্বাচন করুন</option>";
  venues.forEach(v=>{
    venueSelect.innerHTML+=
      `<option value="${v.id}">${v.venue_name}</option>`;
  });
}

function renderStaff(){
  staffBox.innerHTML="";
  staffs.forEach(s=>{
    staffBox.innerHTML+=`
      <label class="staff-item">
        <input type="checkbox" value="${s.id}">
        ${s.name}
      </label>`;
  });
}

/* SAVE ASSIGNMENT */
async function save(){
  if(!type.value){alert("Assignment টাইপ নির্বাচন করুন");return;}
  if(!dutyDate.value){alert("Duty date দিন");return;}

  let staffIds=[], staffNames=[];
  staffBox.querySelectorAll("input:checked").forEach(i=>{
    const st=staffs.find(s=>s.id===i.value);
    if(st){staffIds.push(st.id);staffNames.push(st.name);}
  });
  if(staffIds.length===0){alert("স্টাফ নির্বাচন করুন");return;}

  let data={
    assignment_type:type.value,
    duty_date:dutyDate.value,
    staff_ids:staffIds,
    staff_names:staffNames,
    status:"pending",
    created:Date.now()
  };

  if(type.value==="venue"){
    if(!venueSelect.value){alert("Venue নির্বাচন করুন");return;}
    const v=venues.find(x=>x.id===venueSelect.value);
    data.venue_id=v.id;
    data.venue_name=v.venue_name;
  }else{
    if(!customPlace.value.trim()){
      alert("জায়গার নাম লিখুন");return;
    }
    data.custom_place=customPlace.value.trim();
    data.venue_name=customPlace.value.trim();
  }

  await db.collection("assignments").add(data);
  alert("Assignment তৈরি হয়েছে");
  history.back();
}
</script>

</body>
</html>
