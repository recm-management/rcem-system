<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Assignment</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
.header{
  background:#0d47a1;color:#fff;padding:15px;
  display:flex;align-items:center;gap:12px
}
.container{padding:16px}
select,input{width:100%;padding:12px;margin-bottom:12px;border-radius:12px;border:1px solid #ccc}
.card{background:#fff;padding:14px;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.12)}
.staff-list{max-height:220px;overflow:auto;margin-bottom:12px}
.staff-item{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.btn{
  width:100%;padding:14px;border:none;border-radius:25px;
  background:linear-gradient(45deg,#2e7d32,#43a047);
  color:#fff;font-size:16px;cursor:pointer
}
</style>
</head>

<body>

<div class="header">
  <button onclick="history.back()">← Back</button>
  <h3>Create Assignment</h3>
</div>

<div class="container">
<div class="card">

<select id="type" onchange="toggleType()">
  <option value="">Assignment টাইপ নির্বাচন করুন</option>
  <option value="venue">Venue ভিত্তিক</option>
  <option value="custom">Order / Event ভিত্তিক</option>
</select>

<!-- Venue -->
<select id="venueSelect" style="display:none"></select>

<!-- Custom -->
<input id="customPlace" style="display:none" placeholder="ইভেন্ট / লোকেশনের নাম">

<input type="date" id="dutyDate">

<div class="staff-list" id="staffBox"></div>

<button class="btn" onclick="saveAssignment()">Create Assignment</button>

</div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDK3dqXZuWaH3gctxURdOZc_Q1UfioesaA",
  authDomain:"rcem-system.firebaseapp.com",
  projectId:"rcem-system"
});
const db=firebase.firestore();
const auth=firebase.auth();

let venues=[], staffs=[];

/* LOAD VENUES (সব, active/inactive) */
db.collection("venues").onSnapshot(s=>{
  venues=[];
  s.forEach(d=>{
    const v=d.data();
    if(v.venue_name){
      venues.push({id:d.id,...v});
    }
  });
  venueSelect.innerHTML=`<option value="">Venue নির্বাচন করুন</option>`;
  venues.forEach(v=>{
    venueSelect.innerHTML+=`<option value="${v.id}">${v.venue_name}</option>`;
  });
});

/* LOAD STAFF */
db.collection("users").where("active","==",true).onSnapshot(s=>{
  staffBox.innerHTML="";
  s.forEach(d=>{
    staffBox.innerHTML+=`
      <div class="staff-item">
        <input type="checkbox" value="${d.id}">
        ${d.data().name}
      </div>`;
  });
});

function toggleType(){
  venueSelect.style.display = type.value==="venue"?"block":"none";
  customPlace.style.display = type.value==="custom"?"block":"none";
}

function saveAssignment(){
  if(!type.value){ alert("Assignment টাইপ নির্বাচন করুন"); return; }
  if(!dutyDate.value){ alert("ডিউটি তারিখ দিন"); return; }

  let staffIds=[], staffNames=[];
  document.querySelectorAll("#staffBox input:checked").forEach(i=>{
    staffIds.push(i.value);
    staffNames.push(i.parentNode.innerText.trim());
  });

  let data={
    type:type.value,
    duty_date:dutyDate.value,
    staff_ids:staffIds,
    staff_names:staffNames,
    status:"pending",
    created:firebase.firestore.FieldValue.serverTimestamp()
  };

  if(type.value==="venue"){
    const v=venues.find(x=>x.id===venueSelect.value);
    data.venue_id=v?.id||null;
    data.venue_name=v?.venue_name||"";
  }else{
    data.venue_name=customPlace.value||"নেই";
  }

  db.collection("assignments").add(data)
  .then(()=>{
    alert("Assignment সফলভাবে সেভ হয়েছে");
    location.href="assignments.html";
  })
  .catch(e=>alert(e.message));
}
</script>

</body>
</html>
